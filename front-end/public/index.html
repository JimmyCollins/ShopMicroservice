<!DOCTYPE html>
<html>
<head>

    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

    <!-- Scripts -->
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <script type="text/javascript" language="javascript">

        var headers = ["Product Name", "Price", "Picture", "Quantity", ""];
        var Cartheaders = ["Product Name", "Price", "Picture", "Quantity","Total", ""];



        $(document).ready(function () {

            // Check if cookie exists if so show user as logged in
            var isLoggedIn = getCookie("logged_in");

            if (isLoggedIn != undefined)
            {
                // TODO: How to get user name to show?
                // Store it in cookie also?
            }


        });


        /**
         * Display the cart
         */
        function getCart()
        {
            hideAll();
            $("#cart").show();

            $.ajax({
                dataType: "json",
                url: "/cart",
                success: function (data) {
                    displayCart(data, "cart");
                }
            });
        }


        /**
         * Get the list of products
         */
        function getProducts()
        {
            hideAll();
            $("#products").show();

            $.ajax({
                dataType: "json",
                url: "/getProducts",
                success: function (data) {
                    displayProducts(data, "products");
                }
            });
        }


        /**
         * Hide UI elements
         */
        function hideAll()
        {
            //$("#login").hide();
            $("#register").hide();
            //$("#loginOrRegister").hide();
            $("#newProduct").hide();
            $("#products").hide();
            $("#cart").hide();
        }


        /**
         * Show the login page
         */
        function showLogin()
        {
            hideAll();
            $("#login").show();
        }


        /*function showLoginOrRegister()
        {
            hideAll();
            $("#loginOrRegister").show();
        }*/


        /**
         * Show the registration page
         */
        function showRegister()
        {
            hideAll();
            $("#register").show();
        }


        /**
         * Show the new product page
         */
        function showNewProduct()
        {
            hideAll();
            $("#newProduct").show();

        }


        /**
         * Add an item to the cart
         * @param prodid TODO
         * @param fieldname TODO
         */
        function addToCart(prodid, fieldname)
        {
            var num = document.getElementById(fieldname).value;
            var dat = {
                id: prodid,
                qty : num
            };

            $.ajax
            ({
                type: "POST",
                url: "/cart",
                contentType: 'application/json',

                // JSON object to be sent to the authentication url
                data: JSON.stringify(dat),
                success: function () {

                    $('#alertarea').html("<div class='alert alert-success alert-dismissable'>Car added to cart successfully.<a href='#' class='close' data-dismiss='alert' aria-label='close'>&times;</a></div>");

                    setTimeout(function() {
                        $(".alert").alert('close');
                    }, 2000);

                }
            });
        }



        function checkout()
        {
            // Check if user is logged in first!
            var isLoggedIn = getCookie("logged_in");

            if (isLoggedIn == undefined)
            {
                alert("You need to be logged in to checkout! Please login or register to continue.");
            }

            $.ajax({
                dataType: "json",
                url: "/cart",
                success: function (cartContents) {
                    handleCheckout(cartContents);
                }
            });
        }

        // TODO: Obfuscate
        // See http://stackoverflow.com/questions/10730362/get-cookie-by-name
        // Or http://stackoverflow.com/questions/5639346/what-is-the-shortest-function-for-reading-a-cookie-by-name-in-javascript
        // And https://www.w3schools.com/js/js_cookies.asp
        function getCookie(key){
            var cok = document.cookie.split('; ');
            var x;
            if(cok.length > 1){
                for(var i = 0; i < cok.length; i++){
                    if(cok[i].split('=')[0] == key){
                        x = cok[i].split('=')[1];
                    }
                }
            }
            else if(document.cookie.split('=')[0] == key){
                x = document.cookie.split('=')[1];
            }
            return x;
        }


        function logout()
        {
            // Delete cookies and reload the page
            delete_cookie('customer-id');
            delete_cookie('logged-in');
            delete_cookie('user-type');
            location.reload();
        }

        var delete_cookie = function(name) {
            document.cookie = name + '=;expires=Thu, 01 Jan 1970 00:00:01 GMT;';
        };


        /**
         * Checkout functionality - probably goes to the cart service?
         * @param cart The contents of the current cart
         */
        function handleCheckout(cartContents)
        {
            // Testing
            /*for (i = 0; i < cartContents.length; i++)
            {
                console.log("Name: " + cartContents[i].name);
                console.log("Price: " + cartContents[i].price);
            }*/

            // Create JSON to send to orders service
            var orderData = {};
            orderData.order = new Array();

            var customerId = getCookie("customer_id");

            for (i = 0; i < cartContents.length; i++)
            {
                // TODO: Push single instance of customerID?

                orderData.order.push({
                    "customerId" : customerId,
                    "productId" : cartContents[i].productID,
                    "name" : cartContents[i].name,
                    "price" : cartContents[i].price,
                    "quantity" : cartContents[i].quantity
                })
            }


            var orderDataJson =JSON.stringify(orderData);
            console.log(orderDataJson);

           $.ajax
            ({
                type: "POST",
                url: "/order",
                contentType: 'application/json',
                data: orderDataJson,

                success: function () {

                    // TODO
                    alert("success!");


                },


                error: function (XMLHttpRequest, textStatus, errorThrown) {

                    // TODO: Message user via popoup
                    alert("Something went wrong checking out!");
                }

            });


            //console.log(cartContents);


            /**
             * Get the details of what is in the cart
             * Call into the orders service (via orders\index.js) that should:
             *  1. update the 'orders' table - high level info
             *  2. update the 'orderdetails' table - adds the details on the actual orders
             *
             */

            /*$.post("/order",
                {
                    // TODO




                },
                function (data) {
                    $('#cartmessage').html(data);
                }
            );*/

        }


        /**
         * Delete an item from the cart
         * @param count - TODO - rename to ID or something better?
         */
        function deleteCartItem(count)
        {
            $.ajax({
                url: '/cart/' + count,
                type: 'DELETE',
                success: function(result) {

                    $('#alertarea').html("<div class='alert alert-info alert-dismissable'>Item deleted from Cart.<a href='#' class='close' data-dismiss='alert' aria-label='close'>&times;</a></div>");

                    setTimeout(function() {
                        $(".alert").alert('close');
                    }, 2000);

                    getCart();
                }
            });
        }


        /**
         * TODO - Is this used anywhere?
         * @param itemNo
         */
        /*function myFunction(itemNo)
        {
            str = JSON.stringify(products[itemNo]);
            window.alert("You selected " + str);
        }*/


        /**
         * Show the list of products on the main page
         * @param products TODO
         * @param name TODO
         */
        function displayProducts(products, name)
        {
            var out = '<div class="panel panel-default">';

            out += '<div class="panel-heading">Currently Available Cars</div>'; // TODO: Generalize to products?

            out += "<table class=table borderless>";
            var i;
            out += '<tr" >';

            for (i = 0; i < headers.length; i++)
            {
                out += '<th >' + headers[i] + '</th>';
            }

            out += "</tr>";
            for (i = 0; i < products.length; i++)
            {
                out += "<tr>";
                out += '<td>' + products[i].name + '</td>';
                out += '<td>' + products[i].price + '</td>';
                out += '<td> <img src="';
                out += "images/" + products[i].image + '" style="width:104px;height:100px;">';
                out += '<td>' + '<input class="form-control" type="text" value="1" name="';
                out += 'quantity' + i + '" id="quant' + i
                out += '">' + '</td>';

                out += '<td> <button class="btn btn-success" onclick="addToCart(' + products[i].productID;
                out += ",'quant" + i + "')" + '">Buy</button></td>';
                out += "</tr>";
            }
            out += "</table>";

            out += "</div>";

            document.getElementById(name).innerHTML = out;
        }


        /**
         * Display the cart UI
         * @param cart TODO
         * @param name TODO
         */
        function displayCart(cart, name)
        {
            console.log("displayCart:" + cart);
            console.log("displayCart:" + name);

            var out = '<div class="panel panel-default">';

            out += '<div class="panel-heading">Shopping Cart Contents</div>';

            out += "<table class='table'>";
            var i;
            out += '<tr>';

            for (i = 0; i < Cartheaders.length; i++)
            {
                out += '<th >' + Cartheaders[i] + '</th>';
            }

            out += "</tr>";
            var total=0;

            for (i = 0; i < cart.length; i++)
            {
                out += "<tr>";
                out += '<td>' + cart[i].name + '</td>';
                out += '<td>' + cart[i].price + '</td>';
                out += '<td> <img src="';
                out += "images/" + cart[i].image + '" style="width:104px;height:100px;">';

                out += '<td>' + cart[i].quantity + '</td>';
                out += '<td>' + cart[i].price* cart[i].quantity + '</td>';

                out += '<td> <button class="btn btn-danger" onclick="deleteCartItem(' + cart[i].cartid;
                out1 = ")" + '">Delete</button></td>';
                out += out1;

                out += "</tr>";
                total += cart[i].price* cart[i].quantity;


            }
            out += "</table>";
            out += "</div>";

            out += "<br><br>";
            out += "<h3>Total: <span class='badge'> " + total +'</span></h3><br>';
            out += '<button class="btn btn-primary" onclick="checkout()">Checkout for <span class="badge"</span>' + total + '</button><br>';
            out+='<div id="cartmessage"></div>';
            document.getElementById(name).innerHTML = out;
        }

        //displayProducts(productsData,"products");
    </script>


    <script>

        $(document).ready(function ()
        {
            // Handler for when someone logs in
            $('#logonForm').on( "submit",function(event) {

                event.preventDefault();
                //$("#login").hide();

                var o={};

                var a = $('#logonForm').serializeArray();
                $.each(a, function() {

                    if (o[this.name] !== undefined)
                    {
                        if (!o[this.name].push)
                        {
                            o[this.name] = [o[this.name]];
                        }
                        o[this.name].push(this.value || '');

                    }
                    else
                    {
                        o[this.name] = this.value || '';
                    }

                });

                var fd =JSON.stringify(o);
                console.log(fd);

                $.ajax
                ({
                    type: "POST",
                    url: "/login",
                    contentType: 'application/json',
                    data: fd,
                    success: function () {

                        //$("#alertarea").show();
                        var obj = $.parseJSON(fd);

                        // Set the customer ID in the session?
                        //req.session.customerId

                        // Set the name of the logged in user
                        $('#logged-in-text').text('Logged in as ' + obj['name']);

                        // Hide the login area
                        $("#login-dp").hide();
                        $("#login-area").hide();

                        // Show the logout area and the view orders button
                        $("#logout-area").show();
                        $("#view-orders").show();

                        // If the user is an admin user, show the admin option
                        var isAdmin = getCookie("user_type");

                        if(isAdmin == 1)
                        {
                            $("#adminMenu").show();
                        }


                        // Alert use of successful login
                        $('#alertarea').html("<div class='alert alert-success alert-dismissible'>Logged in Successfully." + obj['name'] +
                            "<a href='#' class='close' data-dismiss='alert' aria-label='close'>&times;</a></div>");

                        setTimeout(function() {
                            $(".alert").alert('close');
                        }, 2000);

                        // TODO: How to retain login after page refresh?

                        // TODO: How to get usertype of logged in user an if=1 show admin pages?

                        // TODO: Should see a View Orders button when user logs in also, that can be used to query for current orders (via the orders service)


                    },

                    error: function(XMLHttpRequest, textStatus, errorThrown) {

                        $('#alertarea').html("<div class='alert alert-danger alert-dismissible'>Please input a valid username and password.<a href='#' class='close' data-dismiss='alert' aria-label='close'>&times;</a></div>");

                        setTimeout(function() {
                            $(".alert").alert('close');
                        }, 5000);


                        //alert("Status: " + textStatus); alert("Error: " + errorThrown);

                    }

                });
            });

            /*$(".alert-dismissible").fadeTo(2000, 500).slideUp(500, function(){
                $(".alert-dismissible").alert('close');
            });*/

            // Handler for when someone registers
            $('#registerForm').on( "submit",function(event)
            {
                event.preventDefault();
                $("#register").hide();
                var o={};
                var a = $('#registerForm').serializeArray();
                $.each(a, function() {
                    if (o[this.name] !== undefined) {
                        if (!o[this.name].push) {
                            o[this.name] = [o[this.name]];
                        }
                        o[this.name].push(this.value || '');
                    } else {
                        o[this.name] = this.value || '';
                    }
                });
                var fd =JSON.stringify(o);
                console.log(fd);
                $.ajax
                ({
                    type: "POST",
                    url: "/register",
                    contentType: 'application/json',
                    data: fd,
                    success: function () {

                        //$("#alertarea").show();
                        $('#alertarea').html("<div class='alert alert-success alert-dismissable'>Thanks for registering! Please login on the top left.<a href='#' class='close' data-dismiss='alert' aria-label='close'>&times;</a></div>");

                        setTimeout(function() {
                            $(".alert").alert('close');
                        }, 2000);
                    }
                });

            });

            // Handler for when a new product is submitted -- TODO - Move to calling the Stock management service?
            $('#newProductForm').on( "submit",function(event)
            {
                event.preventDefault();
                $("#newProduct").hide();
                var fd = $('#newProductForm').serialize();

                $.post(
                        "http://localhost:3002/newProduct",  // JC FIXME: Should go through 'wrapper' located in 'api'.
                        fd,
                        function (data) {
                            console.log(data);
                            //$('#logonmessage').html(data);
                            //$("#alertarea").show();
                            $('#alertarea').html("<div class='alert alert-success alert-dismissable'>New car added!<a href='#' class='close' data-dismiss='alert' aria-label='close'>&times;</a></div>");

                            setTimeout(function() {
                                $(".alert").alert('close');
                            }, 2000);
                        }
                );


            });

            // Used for the login/registration forms
            /*$('#login-form-link').click(function(e) {
                $("#logonForm").delay(100).fadeIn(100);
                $("#registerForm").fadeOut(100);
                $('#register-form-link').removeClass('active');
                $(this).addClass('active');
                e.preventDefault();
            });
            $('#register-form-link').click(function(e) {
                $("#registerForm").delay(100).fadeIn(100);
                $("#logonForm").fadeOut(100);
                $('#login-form-link').removeClass('active');
                $(this).addClass('active');
                e.preventDefault();
            });*/


            //
            getProducts();
            $("#view-orders").hide();
            $("#logout-area").hide();
            $("#adminMenu").hide();
            //$("#login").hide();
            //$('#register').hide();
            //$('#loginOrRegister').hide();
            //$("#newProduct").hide();

        });
    </script>
</head>


<body>

<div class="container-fluid">

    <!--<header>
        <h1>Car Dealership</h1>
    </header>-->

    <div class="panel panel-default">
        <div class="panel-body">

            <!-- The main navigation bar
            <nav class="navbar navbar-default">
                <div class="container-fluid" style="text-align: center">
                    <ul class="nav navbar-nav">
                        <li>
                            <a onclick="showLoginOrRegister()">Login or Register</a>
                        </li>
                        <li>
                            <a onclick="getProducts()">Show Cars</a>
                        </li>
                        <li>
                            <a onclick="getCart()">Show Cart</a>
                        </li>
                        <li>
                            <a onclick="showNewProduct()">New Product</a>
                        </li>
                    </ul>
                </div>
            </nav>-->

            <!-- REF: http://bootsnipp.com/snippets/featured/fancy-navbar-login-sign-in-form -->
            <nav class="navbar navbar-default navbar-inverse" role="navigation">
                <div class="container-fluid">
                    <!-- Brand and toggle get grouped for better mobile display -->
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="#">Super Carz</a>
                    </div>

                    <!-- Collect the nav links, forms, and other content for toggling -->
                    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                        <ul class="nav navbar-nav">
                            <li><a onclick="getProducts()">Show Cars</a></li>
                            <li><a onclick="getCart()">Show Cart</a></li>

                            <!-- TODO - only show if Admin user -->
                            <li class="dropdown" id="adminMenu">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Site Administration<span class="caret"></span></a>
                                <ul class="dropdown-menu" role="menu">
                                    <li><a onclick="showNewProduct()">New Product</a></li>
                                    <li><a href="#">Stock Levels</a></li>   <!-- TODO: Create UI for stock levels and link here -->
                                    <!--<li><a href="#">Another action</a></li>
                                    <li><a href="#">Something else here</a></li>
                                    <li class="divider"></li>
                                    <li><a href="#">Separated link</a></li>
                                    <li class="divider"></li>
                                    <li><a href="#">One more separated link</a></li>-->
                                </ul>
                            </li>

                        </ul>

                        <form class="navbar-form navbar-left" role="search">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search">
                            </div>
                            <button type="submit" class="btn btn-default">Submit</button>
                        </form>

                        <ul class="nav navbar-nav navbar-right">
                            <li><p class="navbar-text" id="logged-in-text"><b>Already have an account?</b></p></li>
                            <li><p class="navbar-text" id="view-orders"><b><a href="#">View Orders</a></b></p></li>
                            <li><p class="navbar-text" id="logout-area"><b><a onclick="logout()">Logout</a></b></p></li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" id="login-area" data-toggle="dropdown"><b>Login</b> <span class="caret"></span></a>
                                <ul id="login-dp" class="dropdown-menu">
                                    <li>
                                        <div class="row">
                                            <div class="col-md-12">
                                                <!--Login via
                                                <div class="social-buttons">
                                                    <a href="#" class="btn btn-fb"><i class="fa fa-facebook"></i> Facebook</a>
                                                    <a href="#" class="btn btn-tw"><i class="fa fa-twitter"></i> Twitter</a>
                                                </div>
                                                or-->
                                                <form class="form" role="form" method="post" action="" accept-charset="UTF-8" id="logonForm">
                                                    <div class="form-group">
                                                        <label class="sr-only" for="usernameLogonForm">Email address</label>
                                                        <input type="text" name="name" class="form-control" id="usernameLogonForm" placeholder="Username" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label class="sr-only" for="passwordLogonForm">Password</label>
                                                        <input type="password" name="password" class="form-control" id="passwordLogonForm" placeholder="Password" required>
                                                        <!--<div class="help-block text-right"><a href="">Forget the password ?</a></div>-->
                                                    </div>
                                                    <div class="form-group">
                                                        <button type="submit" class="btn btn-primary btn-block">Sign in</button>
                                                    </div>
                                                    <!--<div class="checkbox">
                                                        <label>
                                                            <input type="checkbox"> keep me logged-in
                                                        </label>
                                                    </div>-->
                                                </form>
                                            </div>
                                            <div class="bottom text-center">
                                                New here? <a onclick="showRegister()">Join Us</a></a>
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </div><!-- /.navbar-collapse -->
                </div><!-- /.container-fluid -->
            </nav>

            <div id="alertarea"></div>
            <div id="cart"></div>
            <div id="products"></div>
            <!--<div id="logonmessage"></div>-->

            <!-- Login UI -->
            <!--<div id="login">
                <h1>Login</h1>
                <p>

                <form id="logonForm" action="">
                    <div class="form-group">

                        Name:<br>
                        <input type="text" name="name" value="">
                        <br>
                        Password:<br>
                        <input type="text" name="password" value="">
                        <br>
                        <br>
                        <input type="submit" class="btn btn-primary">
                    </div>
                </form>
            </div>-->

            <!-- REG FORM WAS HERE -->


            <!-- Registration UI -->
            <div id="register">
                <h1>Register</h1>
                <p>

                <form id="registerForm" action="">

                    Name:<br>
                    <input type="text" name="name" value="">
                    <br>
                    Address:<br>
                    <input type="text" name="address" value="">
                    <br>
                    Password:<br>
                    <input type="text" name="password" value="">
                    <br>
                    <br>
                    <input type="submit" class="btn btn-primary">
                </form>
            </div>

            <!--<div id="register">
            <div class="panel-body">
                <div class="row">
                    <div class="col-lg-12">

                        <form id="registerForm" action="" method="post" role="form" style="display: none;">
                            <div class="form-group">
                                <input type="text" name="name" id="username" tabindex="1" class="form-control" placeholder="Username" value="">
                            </div>
                            <div class="form-group">
                                <input type="email" name="email" id="email" tabindex="1" class="form-control" placeholder="Email Address" value="">
                            </div>
                            <div class="form-group">
                                <input type="password" name="password" id="password" tabindex="2" class="form-control" placeholder="Password">
                            </div>
                            <div class="form-group">
                                <input type="password" name="confirm-password" id="confirm-password" tabindex="2" class="form-control" placeholder="Confirm Password">
                            </div>
                            <div class="form-group">
                                <div class="row">
                                    <div class="col-sm-6 col-sm-offset-3">
                                        <input type="submit" name="register-submit" id="register-submit" tabindex="4" class="form-control btn btn-register" value="Register Now">
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>-->

            <!-- New Product UI -->
            <div id="newProduct">
                <h1>New Product</h1>
                <p>

                <form id="newProductForm" action="">

                Name:<br>
                <input type="text" name="name" value="">
                <br>

                Quantity:<br>
                <input type="text" name="quantity" value="">
                <br>

                Price:<br>
                <input type="text" name="price" value="">
                <br>

                Image:<br>
                <input type="text" name="productImage" value="">
                <!--<input type="file" name="productImage" value="">-->
                <br>
                <br>
                <input type="submit" class="btn btn-primary">
                </form>
            </div>

        </div>
    </div>
</div>
</body>
</html>