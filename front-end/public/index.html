<!DOCTYPE html>
<html>
<head>

    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

    <!-- Scripts -->
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <script type="text/javascript" language="javascript">

        // Table Headers
        var headers = ["Product Name", "Price", "Picture", "Description", "Quantity", ""];
        var Cartheaders = ["Product Name", "Price", "Picture", "Quantity","Total", ""];
        var OrderHeaders = ["Order ID", "Sale Date", "Status", ""];
        var OrderDetailsHeaders = ["Order Details ID", "Order ID", "Product ID", "Quantity"];
        var StockManagementHeaders = ["Product ID", "Product Name", "In Stock", "Stock Value", "Add / Remove"];
        var UserManagementHeaders = ["User ID", "Username", "Address", "Administrator", "", ""];

        /**
         * Display the cart
         */
        function getCart()
        {
            hideAll();
            $("#cart").show();

            $.ajax({
                dataType: "json",
                url: "/cart",
                success: function (data) {
                    displayCart(data, "cart");
                }
            });
        }


        /**
         * Get the list of products
         */
        function getProducts()
        {
            hideAll();
            $("#products").show();

            $.ajax({
                dataType: "json",
                url: "/getProducts",
                success: function (data) {
                    displayProducts(data, "products");
                }
            });
        }


        /**
         * Hide all user interface elements
         */
        function hideAll()
        {
            $("#register").hide();
            $("#newProduct").hide();
            $("#products").hide();
            $("#cart").hide();
            $("#orders").hide();
            $("#orderDetails").hide();
            $("#stockLevels").hide();
            $("#allOrderDetails").hide();
            $("#userAdmin").hide();
        }


        /**
         * Show the registration page
         */
        function showRegister()
        {
            hideAll();
            $("#register").show();
        }


        /**
         * Show the new product page
         */
        function showNewProduct()
        {
            hideAll();
            $("#newProduct").show();
        }


        /**
         * Add an item to the cart
         * @param prodid The id of the product
         * @param fieldname The fieldname (used to calculate the quantity)
         */
        function addToCart(prodid, fieldname)
        {
            var num = document.getElementById(fieldname).value;

            var dat = {
                id: prodid,
                qty : num
            };

            $.ajax
            ({
                type: "POST",
                url: "/cart",
                contentType: 'application/json',
                data: JSON.stringify(dat),

                success: function () {

                    $('#alertarea').html("<div class='alert alert-success alert-dismissable'>Car added to cart successfully.<a href='#' class='close' data-dismiss='alert' aria-label='close'>&times;</a></div>");

                    setTimeout(function() {
                        $(".alert").alert('close');
                    }, 2000);

                },

                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    $("#ErrorModal").modal('show');
                }
            });
        }


        /**
         * Checkout functionality
         * */
        function checkout()
        {
            // Check if user is logged in first - we require user details to checkout
            var isLoggedIn = getCookieValue("logged_in");

            if (isLoggedIn == undefined)
            {
                $("#CoNotLoggedInModal").modal('show');
                return;
            }

            $.ajax({
                dataType: "json",
                url: "/cart",

                success: function (cartContents) {
                    handleCheckout(cartContents);
                },

                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    $("#ErrorModal").modal('show');
                }
            });
        }


        /**
         * Checkout functionality
         * @param cart The contents of the current cart
         */
        function handleCheckout(cartContents)
        {
            // Can't checkout if cart is empty
            if(cartContents.length == 0)
            {
                $("#CoCartEmptyModal").modal('show');
                return;
            }

            // Create JSON to send to orders service
            var orderData = {};

            // Customer ID
            var customerId = getCookieValue("customer_id");
            orderData.customerId = customerId;

            // Order details
            orderData.order = new Array();

            for (i = 0; i < cartContents.length; i++)
            {
                orderData.order.push({
                    "productId" : cartContents[i].productID,
                    "name" : cartContents[i].name,
                    "price" : cartContents[i].price,
                    "quantity" : cartContents[i].quantity
                })
            }

            var orderDataJson =JSON.stringify(orderData);
            console.log(orderDataJson);

            $.ajax
            ({
                type: "POST",
                url: "/order",
                contentType: 'application/json',
                data: orderDataJson,

                success: function () {

                    // Order has been recorded successfully
                    $("#CoSuccessModal").modal('show');

                    // Clear the cart and decrement the stock levels
                    for (i = 0; i < cartContents.length; i++)
                    {
                        // Remove item from cart
                        deleteCartItem(cartContents[i].cartid);

                        // Reduce stock level
                        var data = {
                            productId: cartContents[i].productID,
                            removedStock : cartContents[i].quantity
                        };

                        var dataAsJson = JSON.stringify(data);

                        $.ajax
                        ({
                            type: "POST",
                            url: "/removeStock",
                            contentType: 'application/json',
                            data: dataAsJson,

                            success: function () {
                                console.log("Checkout complete - stock levels decremented");
                            },

                            error: function (XMLHttpRequest, textStatus, errorThrown) {
                                console.log("Checkout complete - something went wrong decrementing stock levels");
                            }
                        });
                    }

                    //Bring user to the orders page
                    displayOrders();

                },

                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    $("#ErrorModal").modal('show');
                }

            });
        }

        
        /**
         * Get the value of a cookie
         * @param key The cookie name
         * */
        function getCookieValue(name)
        {
            var allCookies = document.cookie.split('; ');
            var cookie;

            if(allCookies.length > 1)
            {
                for(var i = 0; i < allCookies.length; i++)
                {
                    if(allCookies[i].split('=')[0] == name)
                    {
                        cookie = allCookies[i].split('=')[1];
                    }
                }
            }
            else if(document.cookie.split('=')[0] == name)
            {
                cookie = document.cookie.split('=')[1];
            }
            
            return cookie;
        }


        /**
         * Logout the user
         */
        function logout()
        {
            // Delete necessary cookies and reload the page
            deleteCookie('customer_id');
            deleteCookie('logged_in');
            deleteCookie('user_type');
            deleteCookie('user_name');
            reload();
        }


        /**
         * Delete a cookie
         * @param name The cookie name
         */
        function deleteCookie(name)
        {
            document.cookie = name + '=;expires=Thu, 01 Jan 1970 00:00:01 GMT;';
        }


        /**
         * Delete an item from the cart
         * @param id The id of the element in the cart to delete
         */
        function deleteCartItem(id)
        {
            $.ajax({
                url: '/cart/' + id,
                type: 'DELETE',

                success: function(result) {

                    $('#alertarea').html("<div class='alert alert-info alert-dismissable'>Item deleted from Cart.<a href='#' class='close' data-dismiss='alert' aria-label='close'>&times;</a></div>");

                    setTimeout(function() {
                        $(".alert").alert('close');
                    }, 2000);

                    getCart();
                },

                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    $("#ErrorModal").modal('show');
                }
            });
        }


        /**
         * Show the list of products on the main page
         * @param products The product data
         * @param name The name of the HTML element where we'll add the product markup
         */
        function displayProducts(products, name)
        {
            var out = '<div class="panel panel-default">';

            out += '<div class="panel-heading">Currently Available Cars</div>';

            out += "<table class=table borderless>";
            var i;
            out += '<tr" >';

            for (i = 0; i < headers.length; i++)
            {
                out += '<th >' + headers[i] + '</th>';
            }

            out += "</tr>";
            for (i = 0; i < products.length; i++)
            {
                out += "<tr>";
                out += '<td><b><font size="3px">' + products[i].name + '</font></b></td>';
                out += '<td>' + products[i].price + '</td>';
                out += '<td> <img src="';
                out += "images/" + products[i].image + '" style="width:208px;height:200px;">';

                out += '<td>' + products[i].description + '</td>';

                // Display out of stock notification instead of add to cart button if stock levels are zero
                if(products[i].quantity == 0)
                {
                    out += '<td> <img src="';
                    out += "images/" + "out-of-stock.jpg" + '" style="width:104px;height:100px;">';
                    out += '</td><td></td>';
                }
                else
                {
                    out += '<td>' + '<input class="form-control" type="text" value="1" name="';
                    out += 'quantity' + i + '" id="quant' + i
                    out += '">' + '</td>';

                    out += '<td> <button class="btn btn-success" onclick="addToCart(' + products[i].productID;
                    out += ",'quant" + i + "')" + '">Add to Cart</button></td>';
                }

                out += "</tr>";
            }
            out += "</table>";

            out += "</div>";

            document.getElementById(name).innerHTML = out;
        }


        /**
         * Display the cart UI
         * @param cart The cart data
         * @param name The name of the HTML element where we'll add the cart markup
         */
        function displayCart(cart, name)
        {
            var out = '<div class="panel panel-default">';

            out += '<div class="panel-heading">Shopping Cart Contents</div>';

            out += "<table class='table'>";
            var i;
            out += '<tr>';

            for (i = 0; i < Cartheaders.length; i++)
            {
                out += '<th >' + Cartheaders[i] + '</th>';
            }

            out += "</tr>";
            var total=0;

            for (i = 0; i < cart.length; i++)
            {
                out += "<tr>";
                out += '<td>' + cart[i].name + '</td>';
                out += '<td>' + cart[i].price + '</td>';
                out += '<td> <img src="';
                out += "images/" + cart[i].image + '" style="width:104px;height:100px;">';

                out += '<td>' + cart[i].quantity + '</td>';
                out += '<td>' + cart[i].price* cart[i].quantity + '</td>';

                out += '<td> <button class="btn btn-danger" onclick="deleteCartItem(' + cart[i].cartid;
                out1 = ")" + '">Delete</button></td>';
                out += out1;

                out += "</tr>";
                total += cart[i].price* cart[i].quantity;
            }

            out += "</table>";
            out += "</div>";

            out += "<br><br>";
            out += "<h3>Total: <span class='badge'> " + total +'</span></h3><br>';
            out += '<button class="btn btn-primary" onclick="checkout()">Checkout for <span class="badge"</span>' + total + '</button><br>';
            out+='<div id="cartmessage"></div>';

            document.getElementById(name).innerHTML = out;
        }


        /**
         * Grabs the orders for the current user
         */
        function displayOrders()
        {
            var customerId = getCookieValue("customer_id");

            $.ajax({
                dataType: "json",
                url: "/order",
                data:
                    {
                        customerId: customerId
                    },

                success: function (data) {
                    handleDisplayOrders(data);
                },

                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    $("#ErrorModal").modal('show');
                }
            });
        }


        /**
         * Handles displaying the orders for the current user
         * @param orderData The order data to display
         */
        function handleDisplayOrders(orderData)
        {
            if(orderData.length == 0)
            {
                $("#NoOrdersModal").modal('show');
                return;
            }

            var out = '<div class="panel panel-default">';
            out += '<div class="panel-heading">Your Orders</div>';

            out += "<table class='table'>";
            var i;
            out += '<tr>';

            for (i = 0; i < OrderHeaders.length; i++)
            {
                out += '<th>' + OrderHeaders[i] + '</th>';
            }

            out += "</tr>";

            for (i = 0; i < orderData.length; i++)
            {
                out += "<tr>";
                out += '<td>' + orderData[i].orderID + '</td>';
                out += '<td>' + orderData[i].saledate + '</td>';

                out += '<td>' + orderData[i].status + '</td>';

                out += '<td> <button class="btn btn-success" onclick="viewOrderDetails(' + orderData[i].orderID;
                out1 = ")" + '">View Order Details</button></td>';
                out += out1;

                out += "</tr>";
            }

            out += "</table>";
            out += "</div>";

            out += "</div>";

            out += "</div>";

            document.getElementById("orders").innerHTML = out;
            hideAll();
            $("#orders").show();
        }


        /**
         * Grabs details of a specific order
         * @param orderId The ID of the order in the database
         */
        function viewOrderDetails(orderId)
        {
            $.ajax({
                dataType: "json",
                url: "/orderDetails",
                data:
                    {
                        orderId: orderId
                    },

                success: function (data) {
                    handleDisplayOrderDetails(data);
                },

                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    $("#ErrorModal").modal('show');
                }
            });
        }


        /**
         * Handles displaying details of a specific order
         * @param orderDetails The order data to display
         */
        function handleDisplayOrderDetails(orderDetails)
        {
            var out = '<div class="panel panel-default">';
            out += '<div class="panel-heading">Order Details</div>';

            out += "<table class='table'>";
            var i;
            out += '<tr>';

            for (i = 0; i < OrderDetailsHeaders.length; i++)
            {
                out += '<th>' + OrderDetailsHeaders[i] + '</th>';
            }

            out += "</tr>";

            for (i = 0; i < orderDetails.length; i++)
            {
                out += "<tr>";
                out += '<td>' + orderDetails[i].orderdetailsID + '</td>';
                out += '<td>' + orderDetails[i].orderID + '</td>';
                out += '<td>' + orderDetails[i].productID + '</td>';
                out += '<td>' + orderDetails[i].quantity + '</td>';
                out += "</tr>";
            }

            out += "</table>";
            out += "</div>";

            out += "</div>";

            out += "</div>";

            document.getElementById("orderDetails").innerHTML = out;
            hideAll();
            $("#orderDetails").show();
        }


        /**
         * Grabs the stock level data
         */
        function displayStockLevels()
        {
            $.ajax({
                dataType: "json",
                url: "/stockLevels",

                success: function (data) {
                    handleDisplayStockLevels(data);
                },

                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    $("#ErrorModal").modal('show');
                }
            });
        }


        /**
         * Handles displaying the stock level data
         * @param stockData The stock data to display
         */
        function handleDisplayStockLevels(stockData)
        {
            var out = '<div class="panel panel-default">';
            out += '<div class="panel-heading">Stock Level Details</div>';

            out += "<table class='table'>";
            var i;
            out += '<tr>';

            for (i = 0; i < StockManagementHeaders.length; i++)
            {
                out += '<th>' + StockManagementHeaders[i] + '</th>';
            }

            out += "</tr>";

            for (i = 0; i < stockData.length; i++)
            {
                out += "<tr>";
                out += '<td>' + stockData[i].productID + '</td>';
                out += '<td>' + stockData[i].name + '</td>';
                out += '<td>' + stockData[i].quantity + '</td>';

                var stockValue = Number(stockData[i].quantity) * Number(stockData[i].price);
                out += '<td>' + stockValue + '</td>';

                out += '<td>' + '<input class="form-control" type="text" value="1" name="';
                out += 'quantity' + i + '" id="stockQuant' + i
                out += '">' + '</td>';

                out += '<td><button class="btn btn-success" onclick="addNewStock(' + stockData[i].productID;
                out += ",'stockQuant" + i + "','" + stockData[i].quantity + "')" + '">Increase Stock Level</button>        ';

                out += '<button class="btn btn-warning" onclick="removeStock(' + stockData[i].productID;
                out += ",'stockQuant" + i + "')" + '">Decrease Stock Level</button>        ';

                if(stockData[i].active == 1)
                {
                    out += '<button class="btn btn-warning" onclick="deactivateStock(' + stockData[i].productID;
                    out += ")" + '">Deactivate Product</button>        ';
                }
                else
                {
                    out += '<button class="btn btn-success" onclick="reactivateStock(' + stockData[i].productID;
                    out += ")" + '">Reactivate Product</button>        ';
                }

                out += '<button class="btn btn-danger" onclick="deleteStock(' + stockData[i].productID;
                out += ")" + '">Delete Product</button></td>';

                out += "</tr>";
            }

            out += "</table>";
            out += "</div>";

            out += "</div>";

            document.getElementById("stockLevels").innerHTML = out;
            hideAll();
            $("#stockLevels").show();
        }


        /**
         * Increase the stock levels for the given product
         * @param productID The product ID
         * @param fieldname The amount to increase the stock by
         * @param currentStock The current stock level
         */
        function addNewStock(productID, fieldname, currentStock)
        {
            var addedStock = document.getElementById(fieldname).value;
            var newStockLevel = Number(currentStock) + Number(addedStock);

            var data = {
                productId: productID,
                newStockLevel : newStockLevel
            };

            var dataAsJson = JSON.stringify(data);

            $.ajax
            ({
                type: "POST",
                url: "/addStock",
                contentType: 'application/json',
                data: dataAsJson,

                success: function () {
                    $("#StockUpdatedModel").modal('show');
                    displayStockLevels();
                },

                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    $("#ErrorModal").modal('show');
                }
            });
        }


        /**
         * Decrease the stock levels for the given product
         * @param productID The product ID
         * @param fieldname The amount to decrease the stock by
         */
        function removeStock(productID, fieldname)
        {
            var removedStock = document.getElementById(fieldname).value;

            var data = {
                productId: productID,
                removedStock : removedStock
            };

            var dataAsJson = JSON.stringify(data);

            $.ajax
            ({
                type: "POST",
                url: "/removeStock",
                contentType: 'application/json',
                data: dataAsJson,

                success: function () {
                    $("#StockUpdatedModel").modal('show');
                    displayStockLevels();
                },

                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    $("#ErrorModal").modal('show');
                }
            });
        }


        /**
         * Grab all historical orders
         */
        function displayAllOrders()
        {
            $.ajax({
                dataType: "json",
                url: "/allOrders",

                success: function (data) {
                    handleDisplayAllOrders(data);
                },

                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    $("#ErrorModal").modal('show');
                }
            });
        }


        /**
         * Handles displaying of all historical orders
         * @param orderData The order data to display
         */
        function handleDisplayAllOrders(orderData)
        {
            if(orderData.length == 0)
            {
                $("#NoOrdersModal").modal('show');
                return;
            }

            var out = '<div class="panel panel-default">';
            out += '<div class="panel-heading">All Customer Orders</div>';

            out += "<table class='table'>";
            var i;
            out += '<tr>';

            for (i = 0; i < OrderHeaders.length; i++)
            {
                out += '<th>' + OrderHeaders[i] + '</th>';
            }

            out += "</tr>";

            for (i = 0; i < orderData.length; i++)
            {
                out += "<tr>";
                out += '<td>' + orderData[i].orderID + '</td>';
                out += '<td>' + orderData[i].saledate + '</td>';

                out += '<td>' + orderData[i].status + '</td>';

                out += '<td> <button class="btn btn-success" onclick="viewOrderDetails(' + orderData[i].orderID;
                out1 = ")" + '">View Order Details</button></td>';
                out += out1;

                out += "</tr>";
            }

            out += "</table>";
            out += "</div>";

            out += "</div>";

            out += "</div>";

            document.getElementById("allOrderDetails").innerHTML = out;
            hideAll();
            $("#allOrderDetails").show();
        }


        /**
         * Deactivate a product on the site
         * @param productId The product ID
         */
        function deactivateStock(productId)
        {
            var data = {
                productId: productId,
            };

            var dataAsJson = JSON.stringify(data);

            $.ajax
            ({
                type: "POST",
                url: "/deactivateProduct",
                contentType: 'application/json',
                data: dataAsJson,

                success: function () {
                    $("#ProductDeactivatedModel").modal('show');
                    displayStockLevels();
                },

                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    $("#ErrorModal").modal('show');
                }
            });
        }


        /**
         * Reactivate a product on the site
         * @param productId The product ID
         */
        function reactivateStock(productId)
        {
            var data = {
                productId: productId,
            };

            var dataAsJson = JSON.stringify(data);

            $.ajax
            ({
                type: "POST",
                url: "/reactivateProduct",
                contentType: 'application/json',
                data: dataAsJson,

                success: function () {
                    $("#ProductReactivatedModel").modal('show');
                    displayStockLevels();
                },

                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    $("#ErrorModal").modal('show');
                }
            });
        }


        /**
         * Completely delete a product
         * @param productId The product ID
         */
        function deleteStock(productId)
        {
            var data = {
                productId: productId,
            };

            var dataAsJson = JSON.stringify(data);

            $.ajax
            ({
                type: "POST",
                url: "/deleteProduct",
                contentType: 'application/json',
                data: dataAsJson,

                success: function () {
                    $("#ProductDeletedModel").modal('show');
                    displayStockLevels();
                },

                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    $("#ErrorModal").modal('show');
                }
            });
        }


        /**
         * Reload home page
         */
        function reload()
        {
            location.reload();
        }


        /**
         * Grab all the user data
         */
        function displayUserAdmin()
        {
            $.ajax({
                dataType: "json",
                url: "/allUsers",

                success: function (data) {
                    handleDisplayUserAdmin(data);
                },

                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    $("#ErrorModal").modal('show');
                }
            });
        }


        /**
         * Handles displaying the user management user interface
         * @param userData The user data to display
         */
        function handleDisplayUserAdmin(userData)
        {
            if(userData.length == 0)
            {
                $("#ErrorModal").modal('show');
                return;
            }

            var out = '<div class="panel panel-default">';
            out += '<div class="panel-heading">User Management</div>';

            out += "<table class='table'>";
            var i;
            out += '<tr>';

            for (i = 0; i < UserManagementHeaders.length; i++)
            {
                out += '<th>' + UserManagementHeaders[i] + '</th>';
            }

            out += "</tr>";

            for (i = 0; i < userData.length; i++)
            {
                out += "<tr>";
                out += '<td>' + userData[i].userID + '</td>';
                out += '<td>' + userData[i].name + '</td>';
                out += '<td>' + userData[i].address + '</td>';

                if(userData[i].usertype == 1)
                {
                    out += '<td>Yes</td>';
                }
                else
                {
                    out += '<td>No</td>';
                }

                out += '<td> <button class="btn btn-danger" onclick="deleteUser(' + userData[i].userID;
                out1 = ")" + '">Delete</button></td>';
                out += out1;

                if(userData[i].usertype == 2)
                {
                    out += '<td> <button class="btn btn-success" onclick="makeUserAdmin(' + userData[i].userID;
                    out1 = ")" + '">Assign Admin</button></td>';
                    out += out1;
                }
                else
                {
                    out += '<td> <button class="btn btn-warning" onclick="revokeUserAdmin(' + userData[i].userID;
                    out1 = ")" + '">Unassign Admin</button></td>';
                    out += out1;
                }

                out += "</tr>";
            }

            out += "</table>";
            out += "</div>";

            out += "</div>";

            out += "</div>";

            document.getElementById("userAdmin").innerHTML = out;
            hideAll();
            $("#userAdmin").show();

        }


        /**
         * Deletes a user
         * @param userID The user ID of the user to delete
         */
        function deleteUser(userID)
        {
            var data = {
                userID: userID,
            };

            var dataAsJson = JSON.stringify(data);

            $.ajax
            ({
                type: "POST",
                url: "/deleteUser",
                contentType: 'application/json',
                data: dataAsJson,

                success: function () {
                    $("#UserDeletedModal").modal('show');
                    displayUserAdmin();
                },

                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    $("#ErrorModal").modal('show');
                }
            });
        }


        /**
         * Make a user an administrator
         * @param userID The user ID of the user to make an administrator
         */
        function makeUserAdmin(userID)
        {
            var data = {
                userID: userID,
            };

            var dataAsJson = JSON.stringify(data);

            $.ajax
            ({
                type: "POST",
                url: "/makeUserAdmin",
                contentType: 'application/json',
                data: dataAsJson,

                success: function () {
                    $("#UserTypeChangedModal").modal('show');
                    displayUserAdmin();
                },

                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    $("#ErrorModal").modal('show');
                }
            });
        }


        /**
         * Revoke a users administrator access
         * @param userID The user ID of the user for which to revoke access
         */
        function revokeUserAdmin(userID)
        {
            var data = {
                userID: userID,
            };

            var dataAsJson = JSON.stringify(data);

            $.ajax
            ({
                type: "POST",
                url: "/revokeUserAdmin",
                contentType: 'application/json',
                data: dataAsJson,

                success: function () {
                    $("#UserTypeChangedModal").modal('show');
                    displayUserAdmin();
                },

                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    $("#ErrorModal").modal('show');
                }
            });
        }


    </script>


    <script>

        $(document).ready(function ()
        {
            // Handler for when someone logs in
            $('#logonForm').on( "submit",function(event) {

                event.preventDefault();

                var o={};

                var a = $('#logonForm').serializeArray();
                $.each(a, function() {

                    if (o[this.name] !== undefined)
                    {
                        if (!o[this.name].push)
                        {
                            o[this.name] = [o[this.name]];
                        }
                        o[this.name].push(this.value || '');
                    }
                    else
                    {
                        o[this.name] = this.value || '';
                    }
                });

                var fd =JSON.stringify(o);

                $.ajax
                ({
                    type: "POST",
                    url: "/login",
                    contentType: 'application/json',
                    data: fd,
                    success: function () {

                        var obj = $.parseJSON(fd);

                        // Set the name of the logged in user
                        $('#logged-in-text').text('Logged in as ' + obj['name']);

                        // Hide the login area
                        $("#login-dp").hide();
                        $("#login-area").hide();

                        // Show the logout area and the view orders button
                        $("#logout-area").show();
                        $("#view-orders").show();

                        // If the user is an admin user, show the admin option
                        var isAdmin = getCookieValue("user_type");

                        if(isAdmin == 1)
                        {
                            $("#adminMenu").show();
                        }

                        // Alert use of successful login
                        $('#alertarea').html("<div class='alert alert-success alert-dismissible'>Logged in Successfully." + obj['name'] +
                            "<a href='#' class='close' data-dismiss='alert' aria-label='close'>&times;</a></div>");

                        setTimeout(function() {
                            $(".alert").alert('close');
                        }, 2000);
                    },

                    error: function(XMLHttpRequest, textStatus, errorThrown) {

                        $('#alertarea').html("<div class='alert alert-danger alert-dismissible'>Please input a valid username and password.<a href='#' class='close' data-dismiss='alert' aria-label='close'>&times;</a></div>");

                        setTimeout(function() {
                            $(".alert").alert('close');
                        }, 5000);
                    }

                });
            });

            // Handler for when someone registers
            $('#registerForm').on( "submit",function(event)
            {
                event.preventDefault();
                $("#register").hide();

                var o={};

                var a = $('#registerForm').serializeArray();
                $.each(a, function() {
                    if (o[this.name] !== undefined)
                    {
                        if (!o[this.name].push)
                        {
                            o[this.name] = [o[this.name]];
                        }
                        o[this.name].push(this.value || '');
                    }
                    else
                    {
                        o[this.name] = this.value || '';
                    }
                });

                var fd =JSON.stringify(o);

                $.ajax
                ({
                    type: "POST",
                    url: "/register",
                    contentType: 'application/json',
                    data: fd,

                    success: function () {
                        $("#RegistrationSuccessModel").modal('show');
                    },

                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        $("#ErrorModal").modal('show');
                    }
                });

            });

            // Handler for when a new product is submitted
            $('#newProductForm').on( "submit",function(event)
            {
                event.preventDefault();
                $("#newProduct").hide();

                var o={};

                var a = $('#newProductForm').serializeArray();
                $.each(a, function()
                {
                    if (o[this.name] !== undefined)
                    {
                        if (!o[this.name].push)
                        {
                            o[this.name] = [o[this.name]];
                        }
                        o[this.name].push(this.value || '');
                    }
                    else
                    {
                        o[this.name] = this.value || '';
                    }
                });

                var fd =JSON.stringify(o);

                $.ajax
                ({
                    type: "POST",
                    url: "/newProduct",
                    contentType: 'application/json',
                    data: fd,
                    success: function () {
                        reload();
                    },

                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        $("#ErrorModal").modal('show');
                    }
                });
            });

            // Check if cookie exists if so show user as logged in
            var isLoggedIn = getCookieValue("logged_in");

            if (isLoggedIn != undefined)
            {
                var name = getCookieValue("user_name");

                // Set the name of the logged in user
                $('#logged-in-text').text('Logged in as ' + name);

                // Hide the login area
                $("#login-dp").hide();
                $("#login-area").hide();

                // Show the logout area and the view orders button
                $("#logout-area").show();
                $("#view-orders").show();

                // If the user is an admin user, show the admin option
                var isAdmin = getCookieValue("user_type");

                if (isAdmin == 1)
                {
                    $("#adminMenu").show();
                }

                getProducts();
            }
            else
            {
                getProducts();
                $("#view-orders").hide();
                $("#logout-area").hide();
                $("#adminMenu").hide();
            }

        });
    </script>
</head>


<body>

<div class="container-fluid">

    <div class="panel panel-default">
        <div class="panel-body">

            <nav class="navbar navbar-default navbar-inverse" role="navigation">
                <div class="container-fluid">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" onclick="reload()">Super Carz Inc.</a>
                    </div>

                    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                        <ul class="nav navbar-nav">
                            <li><a onclick="getProducts()">Show Cars</a></li>
                            <li><a onclick="getCart()">Show Cart</a></li>

                            <li class="dropdown" id="adminMenu">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Site Administration<span class="caret"></span></a>
                                <ul class="dropdown-menu" role="menu">
                                    <li><a onclick="showNewProduct()">New Product</a></li>
                                    <li><a onclick="displayStockLevels()">Stock Management</a></li>
                                    <li><a onclick="displayUserAdmin()">User Management</a></li>
                                    <li><a onclick="displayAllOrders()">View All Orders</a></li>
                                </ul>
                            </li>

                        </ul>

                        <ul class="nav navbar-nav navbar-right">
                            <li><p class="navbar-text" id="logged-in-text"><b>Already have an account?</b></p></li>
                            <li><p class="navbar-text" id="view-orders"><b><a onclick="displayOrders()">View My Orders</a></b></p></li>
                            <li><p class="navbar-text" id="logout-area"><b><a onclick="logout()">Logout</a></b></p></li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" id="login-area" data-toggle="dropdown"><b>Login</b> <span class="caret"></span></a>
                                <ul id="login-dp" class="dropdown-menu">
                                    <li>
                                        <div class="row">
                                            <div class="col-md-12">
                                                <form class="form" role="form" method="post" action="" accept-charset="UTF-8" id="logonForm">
                                                    <div class="form-group">
                                                        <label class="sr-only" for="usernameLogonForm">Email address</label>
                                                        <input type="text" name="name" class="form-control" id="usernameLogonForm" placeholder="Username" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label class="sr-only" for="passwordLogonForm">Password</label>
                                                        <input type="password" name="password" class="form-control" id="passwordLogonForm" placeholder="Password" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <button type="submit" class="btn btn-primary btn-block">Sign in</button>
                                                    </div>
                                                </form>
                                            </div>
                                            <div class="bottom text-center">
                                                New here? <a onclick="showRegister()">Join Us</a></a>
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>

            <div id="alertarea"></div>
            <div id="cart"></div>
            <div id="products"></div>
            <div id="orders"></div>
            <div id="orderDetails"></div>
            <div id="stockLevels"></div>
            <div id="allOrderDetails"></div>
            <div id="userAdmin"></div>

            <!-- Registration UI -->
            <div id="register">
                <h2>Register</h2>
                <p>

                <form id="registerForm" action="">

                    Name:<br>
                    <input type="text" name="name" value="">
                    <br>
                    Address:<br>
                    <input type="text" name="address" value="">
                    <br>
                    Password:<br>
                    <input type="text" name="password" value="">
                    <br>
                    <br>
                    <input type="submit" class="btn btn-primary">
                </form>
            </div>

            <!-- New Product UI -->
            <div id="newProduct">
                <h2>Add New Product</h2>
                <p>

                <form id="newProductForm" action="">

                Name:<br>
                <input type="text" name="name" value="">
                <br>

                Stock Level:<br>
                <input type="text" name="quantity" value="">
                <br>

                Price:<br>
                <input type="text" name="price" value="">
                <br>

                Description:<br>
                <input type="text" name="description" value="">
                <br>

                Image:<br>
                <input type="text" name="productImage" value="">
                <!--<input type="file" name="productImage" value="">-->
                <br>
                <br>
                <input type="submit" class="btn btn-primary">
                </form>
            </div>

            <!-- Checkout - not logged in modal -->
            <div id="CoNotLoggedInModal" class="modal fade" role="dialog">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                            <h4 class="modal-title">Error</h4>
                        </div>
                        <div class="modal-body">
                            <p>You must be logged in to Checkout. Please login or register to continue.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Checkout - success modal -->
            <div id="CoSuccessModal" class="modal fade" role="dialog">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                            <h4 class="modal-title">Order Success</h4>
                        </div>
                        <div class="modal-body">
                            <p>Your order has been successfully placed. We will be in contact with the details of our Swiss bank account.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Checkout - cart empty modal -->
            <div id="CoCartEmptyModal" class="modal fade" role="dialog">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                            <h4 class="modal-title">Information</h4>
                        </div>
                        <div class="modal-body">
                            <p>Your cart is currently empty. Add some items to your cart in order to checkout.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- No orders modal -->
            <div id="NoOrdersModal" class="modal fade" role="dialog">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                            <h4 class="modal-title">Information</h4>
                        </div>
                        <div class="modal-body">
                            <p>No orders found.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stock updated modal -->
            <div id="StockUpdatedModel" class="modal fade" role="dialog">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                            <h4 class="modal-title">Information</h4>
                        </div>
                        <div class="modal-body">
                            <p>Stock levels updated successfully.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Deactivated -->
            <div id="ProductDeactivatedModel" class="modal fade" role="dialog">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                            <h4 class="modal-title">Information</h4>
                        </div>
                        <div class="modal-body">
                            <p>Product has been deactivated and will not be available for sale.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Reactivated -->
            <div id="ProductReactivatedModel" class="modal fade" role="dialog">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                            <h4 class="modal-title">Information</h4>
                        </div>
                        <div class="modal-body">
                            <p>Product has been reactivated and is available for sale again.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Deleted -->
            <div id="ProductDeletedModel" class="modal fade" role="dialog">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                            <h4 class="modal-title">Information</h4>
                        </div>
                        <div class="modal-body">
                            <p>Product has been deleted.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Registration Success -->
            <div id="RegistrationSuccessModel" class="modal fade" role="dialog">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                            <h4 class="modal-title">Information</h4>
                        </div>
                        <div class="modal-body">
                            <p>Thanks for registering! Please login on the top left to access your account.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User deleted -->
            <div id="UserDeletedModal" class="modal fade" role="dialog">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                            <h4 class="modal-title">Information</h4>
                        </div>
                        <div class="modal-body">
                            <p>User deleted successfully.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User type changed -->
            <div id="UserTypeChangedModal" class="modal fade" role="dialog">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                            <h4 class="modal-title">Information</h4>
                        </div>
                        <div class="modal-body">
                            <p>User type changed successfully.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Generic Error modal -->
            <div id="ErrorModal" class="modal fade" role="dialog">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                            <h4 class="modal-title">Error</h4>
                        </div>
                        <div class="modal-body">
                            <p>An error occurred. Please try again later.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
</body>
</html>